# 共识节点选举

Neo是一个开放透明的区块链网络，任何人都可以通过持有NEO发起交易申请成为验证人，或者对申请验证人进行投票，决定共识节点和个数。根据投票情况，按照本章介绍的算法，计算出共识节点。

![](..\images\consensus\vote_candidate.jpg)

Neo网络中的投票是一个动态持续的过程，若投票账户发生NEO资产变动，则被投票地址的票数将随之更新，共识节点也相应变动。

从选举投票到共识节点，需经两个步骤的计算：
1. 根据被投票列表个数的票数，计算出共识节点个数；
2. 根据被选举人的票数，计算出具体的共识节点。

### 共识节点个数

根据用户的投票情况，共识节点个数的投票得到类似如下图形式：

![](..\images\consensus\calculate_consensus_count_0.jpg)

按照如下公式，转化成概率分布函数 F（离散函数），其中投票数的占比即为共识个数 i 的概率。

![](..\images\consensus\formula_vote.jpg)



在概率分布函数上，截取F ∈ [0.25, 0.75]覆盖到的共识节点个数，再对这些点求取期望值，最后与备用共识节点个数比较取最大值，得到最终的共识节点个数。公式如下：

![](..\images\consensus\formula_vote_count.jpg)

- 其中，⌈A⌉ 代表第一个 F<sub>i</sub> >= 0.25 的点

- ⌈B⌉ 代表第一个  F<sub>i</sub> >= 0.75 的点

- min(0.75, F<sub>i</sub>) - max( F<sub>i - 1</sub>, 0.25 )  表示只取阴影部分的概率

- StandbyValidators 代表备用共识节点列表

> [!Note]
>
> 过滤掉共识节点个数中，过大和过小的点，避免对均值造成的过大或过小的影响，故我们只考虑中间部分的投票情况。

### 共识节点

在上面的步骤中，根据投票情况确定了共识节点个数`Count`，再根据申请验证人的投票进行降序排序，取前`Count`个。若申请的验证人不足时，则从备用共识节点进行补充，最后得到当前参与共识的验证人，即议员。

![](..\images\consensus\calculate_consensus_count_1.jpg)

> [!Note]
>
> 创世块作为第一个块，其`NextConsensus`被设定为备用共识节点的2/3多方签名脚本hash值。

## 议员到议长

按照上面的方法，得到了参与本轮共识节点的议员列表，以及议员编号（即列表序号）。根据共识算法，议长由公式`p = (h - v) mod N`决定，其中`h`是当前需要达成共识的块高度；`v`是视图编号，刚开始从0开始；N是议员总数。 

议长在共识阶段，将发送`PrepareRequest`消息，并附带上决定下一个区块共识节点的`NextConsensus`。议长结合打包Block中的交易，与之前的投票情况，计算出下一轮共识节点，再创建三分之二多方签名脚本的hash值作为`block.NextConsensus`，完成本轮交易对下一轮共识节点的锁定。
